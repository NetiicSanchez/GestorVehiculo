<div class="combustible-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>local_gas_station</mat-icon>
        Gestión de Combustible
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Mensaje de éxito -->
      <div *ngIf="successMessage" class="success-message">
        <mat-icon>check_circle</mat-icon>
        <span>{{ successMessage }}</span>
      </div>

      <!-- Botón para nueva carga -->
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="abrirDialogoCarga()">
          <mat-icon>add</mat-icon>
          Registrar Carga de Combustible
        </button>
      </div>

      <!-- Filtros -->
      <div class="filtros-section">
        <mat-form-field appearance="outline" class="filtro-vehiculo">
          <mat-label>Filtrar por Vehículo</mat-label>
          <mat-select [(value)]="vehiculoSeleccionado" (selectionChange)="filtrarPorVehiculo()">
            <mat-option [value]="null">Todos los vehículos</mat-option>
            <mat-option *ngFor="let vehiculo of vehiculos" [value]="vehiculo.id">
              {{ vehiculo.placa }} - {{ vehiculo.marca }} {{ vehiculo.modelo }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filtro-fecha">
          <mat-label>Desde fecha</mat-label>
          <input matInput [matDatepicker]="fechaDesde" [(ngModel)]="fechaDesdeSeleccionada" 
                 (dateChange)="aplicarFiltros()">
          <mat-datepicker-toggle matSuffix [for]="fechaDesde"></mat-datepicker-toggle>
          <mat-datepicker #fechaDesde></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filtro-fecha">
          <mat-label>Hasta fecha</mat-label>
          <input matInput [matDatepicker]="fechaHasta" [(ngModel)]="fechaHastaSeleccionada" 
                 (dateChange)="aplicarFiltros()">
          <mat-datepicker-toggle matSuffix [for]="fechaHasta"></mat-datepicker-toggle>
          <mat-datepicker #fechaHasta></mat-datepicker>
        </mat-form-field>

        <!-- Filtro por mes/año y botón de exportar -->
        <label>Mes:</label>
        <select [(ngModel)]="mesFiltro" (change)="filtrarPorMes()">
          <option [ngValue]="null">Todos</option>
          <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [ngValue]="m">{{ m }}</option>
        </select>
        <label>Año:</label>
        <select [(ngModel)]="anioFiltro" (change)="filtrarPorMes()">
          <option [ngValue]="null">Todos</option>
          <option *ngFor="let y of obtenerAnios()" [ngValue]="y">{{ y }}</option>
        </select>
        <button mat-raised-button color="accent" style="margin-left:16px;vertical-align:middle;" (click)="exportarExcel()">
          <mat-icon>download</mat-icon> Descargar Excel
        </button>
      </div>


      <!-- Loading -->
      <div *ngIf="cargando" class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Cargando datos...</p>
      </div>

      <!-- Error -->
      <div *ngIf="errorCarga && !cargando" class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ errorCarga }}</p>
        <button mat-raised-button color="primary" (click)="cargarDatos()">
          <mat-icon>refresh</mat-icon>
          Reintentar
        </button>
      </div>

  <!-- Tabla de cargas (desktop/tablet) -->
  <div class="tabla-container" *ngIf="!cargando && !errorCarga && !isMobile">
        <mat-table [dataSource]="cargasFiltradas" class="cargas-table">
          <!-- Columna Fecha de Carga -->
          <ng-container matColumnDef="fecha">
            <mat-header-cell *matHeaderCellDef>Fecha Carga</mat-header-cell>
            <mat-cell *matCellDef="let carga">
              {{ formatearFecha(carga.fechaCarga) }}
            </mat-cell>
          </ng-container>

          <!-- Columna Fecha de Registro -->
          <ng-container matColumnDef="fecha_registro">
            <mat-header-cell *matHeaderCellDef>Fecha Registro</mat-header-cell>
            <mat-cell *matCellDef="let carga">
              {{ carga.fechaRegistro | date:'dd/MM/yyyy' }}
            </mat-cell>
          </ng-container>

          <!-- Columna Observaciones -->
          <ng-container matColumnDef="observaciones">
            <mat-header-cell *matHeaderCellDef>Observaciones</mat-header-cell>
            <mat-cell *matCellDef="let carga">{{ carga.observaciones || '-' }}</mat-cell>
          </ng-container>

          <!-- Columna Vehículo -->
          <ng-container matColumnDef="vehiculo">
            <mat-header-cell *matHeaderCellDef>Vehículo</mat-header-cell>
            <mat-cell *matCellDef="let carga">
              <div class="vehiculo-info">
                <strong>{{ carga.placa }}</strong>
                <br>
                <small>{{ carga.marca }} {{ carga.modelo }}</small>
              </div>
            </mat-cell>
          </ng-container>

          <!-- Columna Combustible -->
          <ng-container matColumnDef="combustible">
            <mat-header-cell *matHeaderCellDef>Tipo</mat-header-cell>
            <mat-cell *matCellDef="let carga">{{ carga.tipoCombustible }}</mat-cell>
          </ng-container>

          <!-- Columna Galones -->
          <ng-container matColumnDef="galones">
            <mat-header-cell *matHeaderCellDef>Galones</mat-header-cell>
            <mat-cell *matCellDef="let carga">
              <span class="cantidad">{{ carga.galonesCargados | number:'1.2-2' }} Gal</span>
            </mat-cell>
          </ng-container>

          <!-- Columna Precio -->
          <ng-container matColumnDef="precio">
            <mat-header-cell *matHeaderCellDef>Precio/Gal</mat-header-cell>
            <mat-cell *matCellDef="let carga">
              {{ carga.precioGalon | currency:'GTQ':'symbol':'1.2-2' }}
            </mat-cell>
          </ng-container>

          <!-- Columna Total -->
          <ng-container matColumnDef="total">
            <mat-header-cell *matHeaderCellDef>Total</mat-header-cell>
            <mat-cell *matCellDef="let carga">
              <span class="total-amount">{{ carga.totalPagado | currency:'GTQ':'symbol':'1.2-2' }}</span>
            </mat-cell>
          </ng-container>

          <!-- Columna Kilometraje -->
          <ng-container matColumnDef="kilometraje">
            <mat-header-cell *matHeaderCellDef>Kilometraje</mat-header-cell>
            <mat-cell *matCellDef="let carga">
              {{ carga.kilometrajeActual | number }} km
            </mat-cell>
          </ng-container>

          <!-- Columna Estación -->
          <ng-container matColumnDef="proveedor">
            <mat-header-cell *matHeaderCellDef>Proveedor</mat-header-cell>
            <mat-cell *matCellDef="let carga">{{ carga.proveedorCombustible || 'N/A' }}</mat-cell>
          </ng-container>

          <!-- Columna Acciones -->
          <ng-container matColumnDef="acciones">
            <mat-header-cell *matHeaderCellDef>Acciones</mat-header-cell>
            <mat-cell *matCellDef="let carga">
              <button *ngIf="carga.fotoFactura || $any(carga)['foto_factura']" mat-icon-button color="accent" (click)="verFoto(carga.fotoFactura || $any(carga)['foto_factura'])" matTooltip="Ver foto">
                <mat-icon>photo</mat-icon>
              </button>
              <ng-container *ngIf="!isOperador">
                <button mat-icon-button color="primary" (click)="editarCarga(carga)" 
                        matTooltip="Editar carga">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="eliminarCarga(carga)" 
                        matTooltip="Eliminar carga">
                  <mat-icon>delete</mat-icon>
                </button>
              </ng-container>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="columnasDisplayed"></mat-header-row>
          <mat-row *matRowDef="let row; columns: columnasDisplayed;"></mat-row>
        </mat-table>

        <!-- Mensaje cuando no hay datos -->
        <div *ngIf="cargasFiltradas.length === 0" class="no-data">
          <mat-icon>local_gas_station</mat-icon>
          <h3>No hay cargas de combustible registradas</h3>
          <p>Comienza registrando la primera carga de combustible</p>
        </div>
        <!-- Paginador -->
        <mat-paginator [length]="1000" [pageSize]="pageSize" [pageSizeOptions]="[20, 40, 100]" (page)="cambiarPagina($event)"></mat-paginator>
      </div>

      <!-- Lista de cargas (móvil) -->
      <div class="mobile-list" *ngIf="!cargando && !errorCarga && isMobile">
        <div class="mobile-card" *ngFor="let carga of cargasFiltradas">
          <div class="mc-header">
            <div class="mc-date">
              <span><strong>Fecha Carga:</strong> {{ carga.fechaCarga | date:'dd/MM/yyyy' }}</span><br>
              <span><strong>Fecha Registro:</strong> {{ carga.fechaRegistro | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="mc-actions">
              <button *ngIf="carga.fotoFactura || $any(carga)['foto_factura']" mat-icon-button color="accent" (click)="verFoto(carga.fotoFactura || $any(carga)['foto_factura'])" aria-label="Ver foto">
                <mat-icon>photo</mat-icon>
              </button>
              <ng-container *ngIf="!isOperador">
                <button mat-icon-button color="primary" (click)="editarCarga(carga)" aria-label="Editar">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="eliminarCarga(carga)" aria-label="Eliminar">
                  <mat-icon>delete</mat-icon>
                </button>
              </ng-container>
            </div>
          </div>
          <div class="mc-row">
            <span class="mc-label">Vehículo</span>
            <span class="mc-value">{{ carga.placa }} — {{ carga.marca }} {{ carga.modelo }}</span>
          </div>
          <div class="mc-row">
            <span class="mc-label">Tipo</span>
            <span class="mc-value">{{ carga.tipoCombustible }}</span>
          </div>
          <div class="mc-row">
            <span class="mc-label">Galones</span>
            <span class="mc-value chip blue">{{ carga.galonesCargados | number:'1.2-2' }} Gal</span>
          </div>
          <div class="mc-row">
            <span class="mc-label">Precio/Gal</span>
            <span class="mc-value">{{ carga.precioGalon | currency:'GTQ':'symbol':'1.2-2' }}</span>
          </div>
          <div class="mc-row">
            <span class="mc-label">Total</span>
            <span class="mc-value chip green">{{ carga.totalPagado | currency:'GTQ':'symbol':'1.2-2' }}</span>
          </div>
          <div class="mc-row">
            <span class="mc-label">Kilometraje</span>
            <span class="mc-value">{{ carga.kilometrajeActual | number }} km</span>
          </div>
          <div class="mc-row">
            <span class="mc-label">Proveedor</span>
            <span class="mc-value">{{ carga.proveedorCombustible || 'N/A' }}</span>
          </div>
        </div>
        <div *ngIf="cargasFiltradas.length === 0" class="no-data">
          <mat-icon>local_gas_station</mat-icon>
          <h3>No hay cargas de combustible registradas</h3>
          <p>Comienza registrando la primera carga de combustible</p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
